#!/bin/sh
#
# aliases-to-wiki:
#    chuck alias files for virtual domains into a wiki page
#
# Copyright (c) 2010 United Kingdom Citizens' Online Democracy. 
# All rights reserved.
# Email: <adam@mysociety.org>; WWW: http://blog.amyl.org.uk/
#
# $Id: aliases-to-wiki,v 1.4 2010-09-06 18:03:05 adam Exp $
#

set -x

ALIASDIR=/etc/exim4/virtual
WIKIDIR=/data/vhost/intranet.mysociety.org/data/MySociety/Organisation/Email

if [ ! -d ${WIKIDIR} ] ; then
    mkdir -p ${WIKIDIR}
fi

ls -1 ${ALIASDIR} | while read F; do
    TF=`rename -n 's/\./-/g' ${F} | awk '{print $NF}'`
    if [ -e ${WIKIDIR}/${TF} ] ; then
        rm ${WIKIDIR}/${TF}
    fi

    if [ -e ${WIKIDIR}/${TF}.txt ] ; then
        rm ${WIKIDIR}/${TF}.txt
    fi

    if [ -e ${WIKIDIR}/${TF}.txt,v ] ; then
        rm ${WIKIDIR}/${TF}.txt,v
    fi

# make the header...
## these bits come from mysociety/intranet/cgi-bin/vhost_summary.pl
echo '%META:TOPICINFO{author="AdamMcGreggor" date="1283793241" format="1.1" version="1.1"}%' > ${WIKIDIR}/${TF}.txt
echo '%META:TOPICPARENT{name="WebHome"}%' >> ${WIKIDIR}/${TF}.txt
echo '|  local part  |  clicky thingy  | recipients/destination  |' >> ${WIKIDIR}/${TF}.txt

# build the content:
## for some reason, can't strip the first part in the out line, so
## hackily do this...
awk '!/^(#|$)/ {print $1}' ${ALIASDIR}/${F} | while read L; 
    do
        SL=`echo ${L} | sed 's/://'`
        grep ^${L} ${ALIASDIR}/${F} | \
        awk '{sub(/:/,""); out=""; for(i=2;i<=NF;i++){out=$out" "$i}; print "| " $1 " | "$1"@" "'"${F}"'" " | BAA" $out " |" }' | \
        ## and hackily zap that. Ugh.
        sed "s/BAA${SL}//" >> ${WIKIDIR}/${TF}-unsorted
    done

    ## a-z is nice:
    sort ${WIKIDIR}/${TF}-unsorted >> ${WIKIDIR}/${TF}.txt
    rm ${WIKIDIR}/${TF}-unsorted


# build the version file:
cat << EOF >> "${WIKIDIR}/${TF}.txt,v"
head    1.1;
access;
symbols;
locks; strict;
comment @# @;
expand  @o@;


1.1
date    2010.09.06.17.14.01;    author AdamMcGreggor;   state Exp;
branches;
next    ;


desc
@none
@


1.1
log
@none
@
text
EOF

cat ${WIKIDIR}/${TF}.txt >> "${WIKIDIR}/${TF}.txt,v"

done
