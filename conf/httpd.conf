#
# httpd.conf:
# Apache configuration fragment for lists.mysociety.org.
#
# Copyright (c) 2006 UK Citizens Online Democracy. All rights reserved.
# Email: chris@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: httpd.conf,v 1.34 2006-06-29 11:25:01 chris Exp $
#

RewriteEngine on

# Don't need ".cgi" to refer to CGI scripts. Also, the mailmanlogin script
# needs to be able to impersonate the logged in user, so that it can access
# other scripts on this server. So pass the authenticated user's credentials to
# the script (usually Apache would hide them). This is a hack, and I am
# ashamed.
RewriteRule ^/admin/lists/mailmanlogin$         /admin/lists/mailmanlogin.cgi    [PT,E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

# For the Mailman admin scripts, if the user doesn't have the site admin
# cookie, but is authenticated, then redirect via the script which will create
# it for them.
RewriteCond %{HTTP_COOKIE}          !site=[0-9A-F]+
RewriteCond %{HTTP_USER_AGENT}      !^mailmanlogin
RewriteCond %{HTTP_AUTHORIZATION}   .
RewriteRule ^(/admin/lists/mailman/.*)  /admin/lists/mailmanlogin?url=$1 [R]

<Location /admin/lists>
    Options +ExecCGI
    AddHandler fastcgi-script .cgi
</Location>

<Location /admin/lists/mailman>
    Options +ExecCGI
    SetHandler cgi-script
</Location>

<Location /admin/lists/mailman/confirm>
    Order allow,deny
    Allow from all
    Satisfy any
</Location>

